# Stop unexpected content negotiation
Options -MultiViews

RewriteEngine On

# --- Always serve real files/dirs as-is ---
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteRule ^ - [L]

# --- Whitelist things that must never hit the router ---
# Favicon and icon files - serve directly with proper content types
RewriteRule ^(favicon\.ico|favicon-16x16\.png|favicon-32x32\.png|favicon\.svg|apple-touch-icon\.png|android-chrome-192x192\.png|android-chrome-512x512\.png|site\.webmanifest)$ - [L]

# Other whitelisted files
RewriteRule ^(sitemap.*\.xml|robots\.txt|api/.*)$ - [L]

# --- Sitemap routing ---
RewriteRule ^sitemap\.xml$ sitemap-index.php [L,QSA]
RewriteRule ^sitemap-matrix\.xml$ sitemap-matrix.php [L,QSA]
RewriteRule ^sitemap-static\.xml$ sitemap-static.php [L,QSA]
RewriteRule ^sitemap-blog\.xml$ sitemap-blog.php [L,QSA]

# --- Matrix landing pages ---
RewriteRule ^matrix/(.+)$ matrix-router.php [L,QSA]

# --- Force HTTPS (optional) ---
# Make sure to EXEMPT the whitelisted files to prevent loops
#RewriteCond %{HTTPS} !=on
#RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

# --- Trailing slash normalization (optional) ---
# Avoid applying to files like .xml/.ico
#RewriteCond %{REQUEST_FILENAME} !-f
#RewriteCond %{REQUEST_URI} !\.[a-zA-Z0-9]{2,4}$
#RewriteRule ^(.+[^/])$ /$1/ [R=301,L]

# --- Front controller: everything else to index.php ---
RewriteRule ^ index.php [L]

# --- Favicon and Icon Caching ---
<IfModule mod_expires.c>
  ExpiresActive On
  ExpiresByType image/x-icon "access plus 30 days"
  ExpiresByType image/png    "access plus 30 days"
  ExpiresByType image/svg+xml "access plus 30 days"
</IfModule>
<IfModule mod_headers.c>
  <FilesMatch "^(favicon\.ico|favicon-16x16\.png|favicon-32x32\.png|apple-touch-icon\.png|android-chrome-192x192\.png|android-chrome-512x512\.png|favicon\.svg)$">
    Header set Cache-Control "public, max-age=2592000, stale-while-revalidate=86400"
  </FilesMatch>
</IfModule>