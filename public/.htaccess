# Stop unexpected content negotiation
Options -MultiViews

# BEGIN HoosierCladding-Global
# Security + sane defaults
Header always set X-Content-Type-Options "nosniff"
Header always set Referrer-Policy "strict-origin-when-cross-origin"
Header always set X-Frame-Options "SAMEORIGIN"
Header always set X-XSS-Protection "0"

# Compression
<IfModule mod_deflate.c>
  AddOutputFilterByType DEFLATE application/json text/plain application/x-ndjson
</IfModule>
# END HoosierCladding-Global

RewriteEngine On

# --- Always serve real files/dirs as-is (EXCEPT feeds) ---
RewriteCond %{REQUEST_FILENAME} -f [OR]
RewriteCond %{REQUEST_FILENAME} -d
RewriteCond %{REQUEST_URI} !^/feeds/
RewriteRule ^ - [L]

# --- Whitelist things that must never hit the router ---
# Favicon and icon files - serve directly with proper content types
RewriteRule ^(favicon\.ico|favicon-16x16\.png|favicon-32x32\.png|favicon\.svg|apple-touch-icon\.png|android-chrome-192x192\.png|android-chrome-512x512\.png|site\.webmanifest)$ - [L]

# Other whitelisted files
RewriteRule ^(sitemap.*\.xml|robots\.txt)$ - [L]

# --- NDJSON feeds (must come before XML rules) ---
RewriteRule ^feeds/products\.ndjson$ feeds/products.ndjson.php [L]

# Serve XML directly (bypass PHP router) + cache
RewriteCond %{REQUEST_URI} \.xml(\.gz)?$ [NC]
RewriteRule ^ - [L]

# --- Matrix landing pages ---
RewriteRule ^matrix/(.+)$ matrix-router.php [L,QSA]

# --- Force HTTPS (optional) ---
# Make sure to EXEMPT the whitelisted files to prevent loops
#RewriteCond %{HTTPS} !=on
#RewriteRule ^ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]

# --- Trailing slash normalization (optional) ---
# Avoid applying to files like .xml/.ico
#RewriteCond %{REQUEST_FILENAME} !-f
#RewriteCond %{REQUEST_URI} !\.[a-zA-Z0-9]{2,4}$
#RewriteRule ^(.+[^/])$ /$1/ [R=301,L]

# --- Front controller: everything else to index.php ---
RewriteRule ^ index.php [L]

# Content types + cache
<IfModule mod_headers.c>
  <FilesMatch "\.xml$">
    ForceType application/xml
    Header set Content-Type "application/xml; charset=UTF-8"
    Header set Cache-Control "public, max-age=3600"
  </FilesMatch>
  <FilesMatch "\.xml\.gz$">
    ForceType application/gzip
    Header set Content-Type "application/xml; charset=UTF-8"
    Header set Content-Encoding "gzip"
    Header set Cache-Control "public, max-age=3600"
  </FilesMatch>
  <Files "robots.txt">
    Header set Content-Type "text/plain; charset=UTF-8"
    Header set Cache-Control "public, max-age=3600"
  </Files>
</IfModule>